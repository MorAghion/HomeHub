{
  "id": "arch-001",
  "title": "Vouchers / Bookings Schema Split",
  "agent": "architect",
  "phase": "0.1",
  "priority": "critical",
  "status": "done",
  "depends_on": [],
  "blocks": ["fe-001", "fe-002", "fe-003", "qa-002"],
  "created": "2026-02-22",
  "updated": "2026-02-22T12:00:00Z",
  "description": "Split the current polymorphic vouchers/reservations table into two separate Supabase tables with distinct schemas. Create migration script to move existing data. Add RLS policies and export TypeScript types.",
  "acceptance_criteria": [
    "Table 'vouchers' exists with: id, name, value, issuer, expiry_date, code, image_url, notes, household_id, created_by, created_at",
    "Table 'reservations' exists with: id, name, event_date, time, address, image_url, notes, household_id, created_by, created_at",
    "Migration script migrates all existing data based on item type without loss",
    "RLS policies enforce household-level read/write on both tables",
    "TypeScript interfaces exported from src/types/voucher.ts and src/types/reservation.ts",
    "Sub-hub record stores type field ('voucher' | 'reservation') — not derived at runtime",
    "Old polymorphic table deprecated (kept as backup for 30 days)"
  ],
  "files_to_touch": [
    "supabase/migrations/YYYYMMDD_split_vouchers_reservations.sql",
    "src/types/voucher.ts",
    "src/types/reservation.ts",
    "src/types/sub-hub.ts (add type field)"
  ],
  "open_questions": [],
  "completion_summary": "Created migration supabase/14-split-vouchers-reservations.sql which: (1) creates dedicated 'vouchers' table (id, name, value, issuer, expiry_date, code, image_url, notes, household_id, created_by, created_at); (2) creates dedicated 'reservations' table (id, name, event_date, time, address, image_url, notes, household_id, created_by, created_at); (3) renames voucher_lists.default_type → type so the sub-hub explicitly stores its item kind; (4) migrates all existing voucher_items rows into the correct table by type discriminator, preserving UUIDs for Storage RLS path compatibility; (5) renames voucher_items → voucher_items_backup_20260222 (drop-safe after 2026-03-24); (6) adds indexes + RLS household-level policies + Realtime on both new tables. Also created src/types/voucher.ts (VoucherRow, Voucher, toVoucher, toVoucherRow), src/types/reservation.ts (ReservationRow, Reservation, toReservation, toReservationRow), and src/types/sub-hub.ts (SubHubType, VoucherSubHubRow, VoucherSubHub, toVoucherSubHub). FE agents must update all Supabase queries that previously targeted voucher_items to use vouchers or reservations, and update voucher_lists column references from default_type to type.",
  "notes": "Check existing table structure first. Map each record's type before migrating. Coordinate with Frontend on type exports.",
  "verification": {
    "run_at": "2026-02-22",
    "tables_created": 3,
    "vouchers_migrated": 1,
    "reservations_migrated": 0,
    "backup_total": 1,
    "vouchers_rls": true,
    "reservations_rls": true,
    "subhub_type_col": "type",
    "result": "PASS — all acceptance criteria verified in production"
  }
}
